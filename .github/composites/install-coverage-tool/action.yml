name: "Install Coverage tool"
description: "Installs the required coverage tool for every OS"

outputs:
  opencppcoverage:
    description: "Full path to OpenCppCoverage"
    value: ${{ steps.install-opencppcoverage.outputs.opencppcoverage }}

runs:
  using: "composite"
  steps:
    - name: Install gcov (Linux - gcov)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        if which apt; then
          sudo apt-get update
          sudo apt-get install -y lcov
        else
          echo "Could not find a package manager for this system"
          exit 1
        fi

    - name: Install coverage tools (macOS - llvm-cov)
      if: runner.os == 'macOS'
      shell: bash
      run: |
        brew install llvm
        ln -s "$(brew --prefix llvm)/bin/llvm-cov" /usr/local/bin/llvm-cov || true

    - name: Install coverage tools (Windows - OpenCppCoverage)
      id: install-opencppcoverage
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        choco install OpenCppCoverage -y
        echo "C:\Program Files\OpenCppCoverage" >> $GITHUB_OUTPUT
        echo "opencppcoverage=\"/c/Program Files/OpenCppCoverage\"" >> "$GITHUB_OUTPUT"

    - name: Install gcovr
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python -m pip install gcovr
